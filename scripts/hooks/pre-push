#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=../release/lib.sh
source "${SCRIPT_DIR}/../release/lib.sh"
release_cd_repo_root

declare -A seen=()
while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ "$local_ref" =~ ^refs/tags/(${RELEASE_SEMVER_TAG_PATTERN})$ ]]; then
    seen["${BASH_REMATCH[1]}"]=1
  fi
done

if [[ ${#seen[@]} -eq 0 ]]; then
  exit 0
fi

for tag in "${!seen[@]}"; do
  echo "pre-push: running release checklist for ${tag}"
  IGW_SKIP_PUSH_AUTH_CHECKS=1 ./scripts/release/checklist.sh "${tag}"
done
