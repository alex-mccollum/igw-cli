#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
cd "$ROOT_DIR"

declare -A seen=()
while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ "$local_ref" =~ ^refs/tags/(v[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
    seen["${BASH_REMATCH[1]}"]=1
  fi
done

if [[ ${#seen[@]} -eq 0 ]]; then
  exit 0
fi

for tag in "${!seen[@]}"; do
  echo "pre-push: running release checklist for ${tag}"
  ./scripts/release/checklist.sh "${tag}"
done
